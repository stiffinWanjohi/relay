openapi: 3.1.0
info:
  title: Relay Webhook Delivery API
  description: |
    Relay is a webhook delivery system that guarantees delivery through
    idempotency keys, persistent storage, exponential backoff retries,
    and circuit breakers.

    ## Authentication
    All API requests require an API key passed in the `X-API-Key` header.

    ## Rate Limiting
    API requests are rate limited per API key. Check response headers for limits:
    - `X-RateLimit-Limit`: Maximum requests per window
    - `X-RateLimit-Remaining`: Remaining requests in current window
    - `X-RateLimit-Reset`: Unix timestamp when the window resets
  version: 1.0.0
  contact:
    name: Relay Support
    url: https://github.com/relay/relay
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Local development
  - url: https://api.relay.example.com
    description: Production

tags:
  - name: Events
    description: Webhook event operations
  - name: Endpoints
    description: Webhook endpoint management
  - name: EventTypes
    description: Event type catalog and schema management
  - name: Health
    description: Service health checks

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the service
      operationId: healthCheck
      security: []
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /api/v1/events:
    post:
      tags:
        - Events
      summary: Create a webhook event
      description: |
        Creates a new webhook event for delivery. The event will be queued
        and delivered to the specified destination with automatic retries.

        Use the `X-Idempotency-Key` header to prevent duplicate events.
      operationId: createEvent
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateEventRequest"
      responses:
        "201":
          description: Event created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Event"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: Idempotency conflict - event already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Event"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"

    get:
      tags:
        - Events
      summary: List events
      description: Returns a paginated list of webhook events
      operationId: listEvents
      parameters:
        - name: status
          in: query
          description: Filter by event status
          schema:
            $ref: "#/components/schemas/EventStatus"
        - name: limit
          in: query
          description: Maximum number of events to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: cursor
          in: query
          description: Pagination cursor from previous response
          schema:
            type: string
      responses:
        "200":
          description: List of events
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventList"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/events/{eventId}:
    get:
      tags:
        - Events
      summary: Get event by ID
      description: Returns a single event with its delivery history
      operationId: getEvent
      parameters:
        - $ref: "#/components/parameters/EventId"
      responses:
        "200":
          description: Event details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventWithAttempts"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/events/{eventId}/replay:
    post:
      tags:
        - Events
      summary: Replay an event
      description: |
        Replays a failed or dead event. The event will be re-queued
        for delivery with a fresh retry count.
      operationId: replayEvent
      parameters:
        - $ref: "#/components/parameters/EventId"
      responses:
        "200":
          description: Event replayed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Event"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          description: Event cannot be replayed (not in failed/dead status)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/v1/events/batch/retry:
    post:
      tags:
        - Events
      summary: Batch retry events
      description: |
        Retry multiple failed or dead events in a single request.
        Supports three modes:
        - By IDs: Retry specific events by their UUIDs
        - By status: Retry all events with a given status (failed/dead)
        - By endpoint: Retry all failed/dead events for a specific endpoint
      operationId: batchRetryEvents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BatchRetryRequest"
      responses:
        "200":
          description: Batch retry result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BatchRetryResult"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/endpoints:
    post:
      tags:
        - Endpoints
      summary: Create an endpoint
      description: Creates a new webhook endpoint with subscription rules
      operationId: createEndpoint
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateEndpointRequest"
      responses:
        "201":
          description: Endpoint created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Endpoint"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

    get:
      tags:
        - Endpoints
      summary: List endpoints
      description: Returns a paginated list of webhook endpoints
      operationId: listEndpoints
      parameters:
        - name: status
          in: query
          description: Filter by endpoint status
          schema:
            $ref: "#/components/schemas/EndpointStatus"
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        "200":
          description: List of endpoints
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EndpointList"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/endpoints/{endpointId}:
    get:
      tags:
        - Endpoints
      summary: Get endpoint by ID
      description: Returns endpoint details with statistics
      operationId: getEndpoint
      parameters:
        - $ref: "#/components/parameters/EndpointId"
      responses:
        "200":
          description: Endpoint details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EndpointWithStats"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    patch:
      tags:
        - Endpoints
      summary: Update an endpoint
      description: Updates endpoint configuration
      operationId: updateEndpoint
      parameters:
        - $ref: "#/components/parameters/EndpointId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateEndpointRequest"
      responses:
        "200":
          description: Endpoint updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Endpoint"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      tags:
        - Endpoints
      summary: Delete an endpoint
      description: Deletes an endpoint (pending events will still be delivered)
      operationId: deleteEndpoint
      parameters:
        - $ref: "#/components/parameters/EndpointId"
      responses:
        "204":
          description: Endpoint deleted successfully
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/stats:
    get:
      tags:
        - Health
      summary: Queue statistics
      description: Returns current queue and delivery statistics
      operationId: getStats
      responses:
        "200":
          description: Queue statistics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QueueStats"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/event-types:
    post:
      tags:
        - EventTypes
      summary: Create an event type
      description: |
        Creates a new event type with optional JSONSchema for payload validation.
        Event types allow you to define and document the structure of webhooks
        you send, and optionally validate payloads against the schema.
      operationId: createEventType
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateEventTypeRequest"
      responses:
        "201":
          description: Event type created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventType"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: Event type with this name already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    get:
      tags:
        - EventTypes
      summary: List event types
      description: Returns a paginated list of event types
      operationId: listEventTypes
      parameters:
        - name: limit
          in: query
          description: Maximum number of event types to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Number of event types to skip
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        "200":
          description: List of event types
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventTypeList"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/event-types/{eventTypeId}:
    get:
      tags:
        - EventTypes
      summary: Get event type by ID
      description: Returns a single event type with its schema
      operationId: getEventType
      parameters:
        - $ref: "#/components/parameters/EventTypeId"
      responses:
        "200":
          description: Event type details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventType"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    put:
      tags:
        - EventTypes
      summary: Update an event type
      description: Updates event type description and/or schema
      operationId: updateEventType
      parameters:
        - $ref: "#/components/parameters/EventTypeId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateEventTypeRequest"
      responses:
        "200":
          description: Event type updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventType"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      tags:
        - EventTypes
      summary: Delete an event type
      description: Deletes an event type from the catalog
      operationId: deleteEventType
      parameters:
        - $ref: "#/components/parameters/EventTypeId"
      responses:
        "204":
          description: Event type deleted successfully
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/event-types/by-name/{eventTypeName}:
    get:
      tags:
        - EventTypes
      summary: Get event type by name
      description: Returns an event type by its name
      operationId: getEventTypeByName
      parameters:
        - name: eventTypeName
          in: path
          required: true
          description: Event type name (e.g., "order.created")
          schema:
            type: string
      responses:
        "200":
          description: Event type details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventType"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication

  parameters:
    EventId:
      name: eventId
      in: path
      required: true
      description: Event UUID
      schema:
        type: string
        format: uuid

    EndpointId:
      name: endpointId
      in: path
      required: true
      description: Endpoint UUID
      schema:
        type: string
        format: uuid

    EventTypeId:
      name: eventTypeId
      in: path
      required: true
      description: Event type UUID
      schema:
        type: string
        format: uuid

    IdempotencyKey:
      name: X-Idempotency-Key
      in: header
      required: true
      description: Unique key to prevent duplicate event creation
      schema:
        type: string
        minLength: 1
        maxLength: 255

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
      required:
        - status

    Event:
      type: object
      properties:
        id:
          type: string
          format: uuid
        idempotencyKey:
          type: string
        destination:
          type: string
          format: uri
        eventType:
          type: string
        status:
          $ref: "#/components/schemas/EventStatus"
        attempts:
          type: integer
        maxAttempts:
          type: integer
        createdAt:
          type: string
          format: date-time
        deliveredAt:
          type: string
          format: date-time
          nullable: true
        nextAttemptAt:
          type: string
          format: date-time
          nullable: true
      required:
        - id
        - idempotencyKey
        - destination
        - status
        - attempts
        - maxAttempts
        - createdAt

    EventWithAttempts:
      allOf:
        - $ref: "#/components/schemas/Event"
        - type: object
          properties:
            payload:
              type: object
            headers:
              type: object
              additionalProperties:
                type: string
            deliveryAttempts:
              type: array
              items:
                $ref: "#/components/schemas/DeliveryAttempt"

    DeliveryAttempt:
      type: object
      properties:
        id:
          type: string
          format: uuid
        attemptNumber:
          type: integer
        statusCode:
          type: integer
          nullable: true
        responseBody:
          type: string
          nullable: true
        error:
          type: string
          nullable: true
        durationMs:
          type: integer
        attemptedAt:
          type: string
          format: date-time
      required:
        - id
        - attemptNumber
        - durationMs
        - attemptedAt

    EventStatus:
      type: string
      enum:
        - queued
        - delivering
        - delivered
        - failed
        - dead

    BatchRetryRequest:
      type: object
      properties:
        event_ids:
          type: array
          items:
            type: string
            format: uuid
          description: List of event IDs to retry
        status:
          type: string
          enum: [failed, dead]
          description: Retry all events with this status
        endpoint_id:
          type: string
          format: uuid
          description: Retry all failed/dead events for this endpoint
        limit:
          type: integer
          minimum: 1
          maximum: 1000
          default: 100
          description: Maximum number of events to retry (for status/endpoint modes)

    BatchRetryResult:
      type: object
      properties:
        succeeded:
          type: array
          items:
            $ref: "#/components/schemas/Event"
        failed:
          type: array
          items:
            $ref: "#/components/schemas/BatchRetryError"
        totalRequested:
          type: integer
        totalSucceeded:
          type: integer
      required:
        - succeeded
        - failed
        - totalRequested
        - totalSucceeded

    BatchRetryError:
      type: object
      properties:
        eventId:
          type: string
          format: uuid
        error:
          type: string
      required:
        - eventId
        - error

    CreateEventRequest:
      type: object
      properties:
        destination:
          type: string
          format: uri
          description: Webhook destination URL (required if no eventType)
        eventType:
          type: string
          description: Event type for fan-out to subscribed endpoints
        payload:
          type: object
          description: JSON payload to deliver
        headers:
          type: object
          additionalProperties:
            type: string
          description: Custom headers to include in the webhook request
        maxAttempts:
          type: integer
          minimum: 1
          maximum: 100
          default: 10
          description: Maximum delivery attempts before marking as dead
      required:
        - payload

    EventList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Event"
        pagination:
          $ref: "#/components/schemas/Pagination"
      required:
        - data
        - pagination

    Endpoint:
      type: object
      properties:
        id:
          type: string
          format: uuid
        url:
          type: string
          format: uri
        description:
          type: string
        eventTypes:
          type: array
          items:
            type: string
        status:
          $ref: "#/components/schemas/EndpointStatus"
        filter:
          $ref: "#/components/schemas/Filter"
        transformation:
          type: string
          description: |
            JavaScript code to transform the webhook payload before delivery.
            The code must define a `transform(webhook)` function that receives
            the webhook object with method, url, headers, and payload properties,
            and returns a transformed object with the same properties plus an
            optional `cancel` boolean to skip delivery.
          example: |
            function transform(webhook) {
              return {
                method: 'POST',
                url: webhook.url,
                headers: { ...webhook.headers, 'X-Custom': 'value' },
                payload: { wrapped: webhook.payload },
                cancel: false
              };
            }
        fifo:
          type: boolean
          description: |
            When enabled, events are delivered sequentially - one at a time.
            The next event is only delivered after the previous one completes
            (either successfully or after all retries are exhausted).
          default: false
        fifoPartitionKey:
          type: string
          nullable: true
          description: |
            JSONPath expression to extract a partition key from the event payload.
            Events with the same partition key are delivered in order, but events
            with different partition keys can be processed in parallel.
            Only applicable when fifo is true.
          example: "$.customer_id"
        maxRetries:
          type: integer
        retryBackoffMs:
          type: integer
        retryBackoffMax:
          type: integer
        retryBackoffMult:
          type: number
        timeoutMs:
          type: integer
        rateLimitPerSec:
          type: integer
        circuitThreshold:
          type: integer
        circuitResetMs:
          type: integer
        hasCustomSecret:
          type: boolean
          description: Whether this endpoint has a custom signing secret
        secretRotatedAt:
          type: string
          format: date-time
          nullable: true
          description: When the signing secret was last rotated
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required:
        - id
        - url
        - eventTypes
        - status
        - hasCustomSecret
        - createdAt
        - updatedAt

    EndpointWithStats:
      allOf:
        - $ref: "#/components/schemas/Endpoint"
        - type: object
          properties:
            stats:
              $ref: "#/components/schemas/EndpointStats"

    EndpointStats:
      type: object
      properties:
        totalEvents:
          type: integer
        delivered:
          type: integer
        failed:
          type: integer
        pending:
          type: integer
        successRate:
          type: number
          format: float
        avgLatencyMs:
          type: number
          format: float

    EndpointStatus:
      type: string
      enum:
        - active
        - paused
        - disabled

    Filter:
      type: object
      description: |
        Content-based routing filter for endpoints. Events are only delivered
        if they match the filter conditions. Supports JSONPath expressions
        and logical combinators (and, or, not).
      properties:
        rule:
          $ref: "#/components/schemas/FilterRule"
        and:
          type: array
          description: All conditions must match (logical AND)
          items:
            $ref: "#/components/schemas/Filter"
        or:
          type: array
          description: At least one condition must match (logical OR)
          items:
            $ref: "#/components/schemas/Filter"
        not:
          $ref: "#/components/schemas/Filter"
          description: Negates the nested filter condition

    FilterRule:
      type: object
      description: A single filter condition using JSONPath
      properties:
        path:
          type: string
          description: JSONPath expression (e.g., "$.data.amount")
          example: "$.data.status"
        operator:
          type: string
          description: Comparison operator
          enum:
            - eq
            - ne
            - gt
            - gte
            - lt
            - lte
            - contains
            - startsWith
            - endsWith
            - exists
            - regex
        value:
          description: Value to compare against
          oneOf:
            - type: string
            - type: number
            - type: boolean
      required:
        - path
        - operator
        - value

    CreateEndpointRequest:
      type: object
      properties:
        url:
          type: string
          format: uri
        description:
          type: string
        eventTypes:
          type: array
          items:
            type: string
          minItems: 1
        filter:
          $ref: "#/components/schemas/Filter"
        transformation:
          type: string
          description: JavaScript code to transform the webhook payload before delivery
        fifo:
          type: boolean
          description: Enable FIFO (ordered) delivery - events delivered one at a time
          default: false
        fifoPartitionKey:
          type: string
          description: JSONPath expression for partition key (e.g., "$.customer_id")
        maxRetries:
          type: integer
          minimum: 0
          maximum: 100
          default: 10
        retryBackoffMs:
          type: integer
          minimum: 100
          default: 1000
        retryBackoffMax:
          type: integer
          default: 86400000
        retryBackoffMult:
          type: number
          minimum: 1
          default: 2.0
        timeoutMs:
          type: integer
          minimum: 1000
          maximum: 300000
          default: 30000
        rateLimitPerSec:
          type: integer
          minimum: 0
          default: 0
        circuitThreshold:
          type: integer
          minimum: 1
          default: 5
        circuitResetMs:
          type: integer
          default: 300000
        customHeaders:
          type: object
          additionalProperties:
            type: string
      required:
        - url
        - eventTypes

    UpdateEndpointRequest:
      type: object
      properties:
        url:
          type: string
          format: uri
        description:
          type: string
        eventTypes:
          type: array
          items:
            type: string
        status:
          $ref: "#/components/schemas/EndpointStatus"
        filter:
          $ref: "#/components/schemas/Filter"
        transformation:
          type: string
          description: JavaScript code to transform the webhook payload (set to empty string to remove)
        fifo:
          type: boolean
          description: Enable/disable FIFO (ordered) delivery
        fifoPartitionKey:
          type: string
          description: JSONPath expression for partition key (set to empty string to remove)
        maxRetries:
          type: integer
        retryBackoffMs:
          type: integer
        timeoutMs:
          type: integer
        rateLimitPerSec:
          type: integer

    EndpointList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Endpoint"
        pagination:
          $ref: "#/components/schemas/Pagination"
      required:
        - data
        - pagination

    QueueStats:
      type: object
      properties:
        queued:
          type: integer
        delivering:
          type: integer
        delivered:
          type: integer
        failed:
          type: integer
        dead:
          type: integer
        pending:
          type: integer
        processing:
          type: integer
        delayed:
          type: integer

    EventType:
      type: object
      properties:
        id:
          type: string
          format: uuid
        clientId:
          type: string
        name:
          type: string
          description: Event type name (e.g., "order.created")
        description:
          type: string
          nullable: true
        schema:
          type: object
          nullable: true
          description: JSONSchema for payload validation
        schemaVersion:
          type: string
          nullable: true
          description: Schema version (e.g., "1.0")
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required:
        - id
        - clientId
        - name
        - createdAt
        - updatedAt

    CreateEventTypeRequest:
      type: object
      properties:
        name:
          type: string
          description: Event type name (e.g., "order.created")
          minLength: 1
          maxLength: 255
        description:
          type: string
          description: Human-readable description of this event type
        schema:
          type: object
          description: JSONSchema for payload validation (optional)
        schemaVersion:
          type: string
          description: Version of the schema (e.g., "1.0")
      required:
        - name

    UpdateEventTypeRequest:
      type: object
      properties:
        description:
          type: string
          description: Human-readable description of this event type
        schema:
          type: object
          nullable: true
          description: JSONSchema for payload validation (set to null to remove)
        schemaVersion:
          type: string
          description: Version of the schema

    EventTypeList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/EventType"
        pagination:
          $ref: "#/components/schemas/Pagination"
      required:
        - data
        - pagination

    Pagination:
      type: object
      properties:
        hasMore:
          type: boolean
        cursor:
          type: string
          nullable: true
        total:
          type: integer

    Error:
      type: object
      properties:
        error:
          type: string
        code:
          type: string
        details:
          type: object
      required:
        - error

  responses:
    BadRequest:
      description: Bad request - invalid input
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "Invalid request body"
            code: "BAD_REQUEST"

    Unauthorized:
      description: Unauthorized - missing or invalid API key
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "Invalid API key"
            code: "UNAUTHORIZED"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "Event not found"
            code: "NOT_FOUND"

    UnprocessableEntity:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "URL scheme must be http or https"
            code: "VALIDATION_ERROR"

security:
  - ApiKeyAuth: []
